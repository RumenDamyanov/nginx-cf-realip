# nginx-cf-realip Example Configuration
# 
# This module automatically fetches and maintains Cloudflare's IP ranges,
# enabling accurate real client IP restoration when behind Cloudflare's proxy.
#
# For more information, see: https://github.com/RumenDamyanov/nginx-cf-realip

# ============================================================================
# CONFIGURATION CONTEXT REFERENCE
# ============================================================================
#
# Global settings (http{} block ONLY):
#   - cf_realip_source_url        - IPv4 list URL
#   - cf_realip_source_url_v6     - IPv6 list URL
#   - cf_realip_refresh_interval  - Update interval in seconds
#   - cf_realip_output_path       - Output file path
#   - cf_realip_fetch_ipv6        - Enable IPv6 fetching
#   - cf_realip_allow_insecure    - Allow HTTP URLs
#   - cf_realip_allow_other_hosts - Allow non-cloudflare.com hosts
#
# Per-location settings (http{}, server{}, or location{}):
#   - cf_realip_enabled           - Enable/disable the module
#

# ============================================================================
# 1. MINIMAL CONFIGURATION
# ============================================================================
# The simplest setup - just enable the module and include the generated file.

# load_module modules/ngx_http_cf_realip_module.so;
# 
# http {
#     # Enable the module (fetches Cloudflare IP lists automatically)
#     cf_realip_enabled on;
#     
#     # Include the generated trusted proxy list
#     include /etc/nginx/cloudflare-ips.conf;
#     
#     # Tell NGINX which header contains the real client IP
#     real_ip_header CF-Connecting-IP;
#     real_ip_recursive on;
#     
#     server {
#         listen 80;
#         server_name example.com;
#         
#         location / {
#             # $remote_addr now contains the real client IP
#             proxy_pass http://backend;
#         }
#     }
# }

# ============================================================================
# 2. FULL CONFIGURATION WITH ALL OPTIONS
# ============================================================================
# Complete example showing all available directives.

load_module modules/ngx_http_cf_realip_module.so;

http {
    # --------------------------------------------------------------------------
    # REQUIRED: DNS Resolver Configuration
    # The module needs a resolver to look up Cloudflare's hostname
    # --------------------------------------------------------------------------
    
    # Use Cloudflare's DNS (1.1.1.1) or Google's (8.8.8.8) or local resolver
    resolver 1.1.1.1 8.8.8.8 valid=300s;
    resolver_timeout 5s;
    
    # --------------------------------------------------------------------------
    # Cloudflare Real IP Module - Global Configuration
    # These settings can ONLY be placed in the http{} block
    # --------------------------------------------------------------------------
    
    # Refresh interval in seconds (default: 86400 = 24 hours, minimum: 300)
    cf_realip_refresh_interval 86400;
    
    # Output file path for the generated snippet (default shown)
    cf_realip_output_path /etc/nginx/cloudflare-ips.conf;
    
    # Enable IPv6 range fetching (default: on)
    cf_realip_fetch_ipv6 on;
    
    # Custom source URLs (defaults shown - normally not needed)
    # cf_realip_source_url https://www.cloudflare.com/ips-v4;
    # cf_realip_source_url_v6 https://www.cloudflare.com/ips-v6;
    
    # Security settings (defaults - leave off for production)
    # cf_realip_allow_insecure off;     # Allow HTTP URLs (not recommended)
    # cf_realip_allow_other_hosts off;  # Allow non-cloudflare.com hosts
    
    # --------------------------------------------------------------------------
    # Cloudflare Real IP Module - Per-Location Configuration
    # This can be set in http{}, server{}, or location{} blocks
    # --------------------------------------------------------------------------
    
    # Enable the module (required - can be overridden per server/location)
    cf_realip_enabled on;
    
    # --------------------------------------------------------------------------
    # Standard NGINX Real IP Configuration
    # --------------------------------------------------------------------------
    
    # Include the auto-generated Cloudflare IP ranges
    # This file contains lines like: set_real_ip_from 103.21.244.0/22;
    include /etc/nginx/cloudflare-ips.conf;
    
    # Cloudflare sends the original client IP in this header
    real_ip_header CF-Connecting-IP;
    
    # Enable recursive real IP lookup for chained proxies
    real_ip_recursive on;
    
    # --------------------------------------------------------------------------
    # Logging Configuration (optional but recommended)
    # --------------------------------------------------------------------------
    
    # Log format showing both the proxy IP and real client IP
    log_format cloudflare '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'cf_ip="$http_cf_connecting_ip" '
                          'cf_ray="$http_cf_ray"';
    
    # --------------------------------------------------------------------------
    # Server Configuration
    # --------------------------------------------------------------------------
    
    server {
        listen 80;
        server_name example.com;
        
        access_log /var/log/nginx/access.log cloudflare;
        
        location / {
            # $remote_addr now contains the real client IP (not Cloudflare's)
            # You can use it for:
            # - Access control
            # - Rate limiting
            # - Logging
            # - Geo-targeting
            
            proxy_pass http://127.0.0.1:8080;
            
            # Pass the real IP to your backend
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Example: Rate limiting by real client IP
        location /api/ {
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass http://127.0.0.1:8080;
        }
    }
    
    # Example: Disable the module for a specific server
    server {
        listen 80;
        server_name internal.example.com;
        
        # This server doesn't need Cloudflare IP processing
        cf_realip_enabled off;
        
        location / {
            proxy_pass http://127.0.0.1:9000;
        }
    }
    
    # Rate limiting zone (based on real client IP)
    limit_req_zone $remote_addr zone=api_limit:10m rate=10r/s;
}

# ============================================================================
# 3. CUSTOM OUTPUT PATH EXAMPLE
# ============================================================================
# Use a different output location (e.g., for container environments).

# http {
#     # Global settings in http{} block
#     cf_realip_output_path /var/cache/nginx/cloudflare-trusted.conf;
#     cf_realip_refresh_interval 7200;  # 2 hours
#     
#     # Enable the module
#     cf_realip_enabled on;
#     
#     include /var/cache/nginx/cloudflare-trusted.conf;
#     real_ip_header CF-Connecting-IP;
#     real_ip_recursive on;
# }

# ============================================================================
# 4. IPV4-ONLY CONFIGURATION
# ============================================================================
# Disable IPv6 fetching if your infrastructure is IPv4-only.

# http {
#     # Global settings
#     cf_realip_fetch_ipv6 off;
#     
#     # Enable
#     cf_realip_enabled on;
#     
#     include /etc/nginx/cloudflare-ips.conf;
#     real_ip_header CF-Connecting-IP;
# }

# ============================================================================
# 5. TESTING / DEVELOPMENT CONFIGURATION
# ============================================================================
# Use custom source URLs for testing (requires allow_other_hosts).

# http {
#     # Global settings (http{} block only)
#     cf_realip_allow_other_hosts on;
#     cf_realip_allow_insecure on;  # Only for local testing!
#     cf_realip_source_url http://localhost:8000/test-ips-v4.txt;
#     cf_realip_source_url_v6 http://localhost:8000/test-ips-v6.txt;
#     cf_realip_refresh_interval 300;  # 5 minutes (minimum)
#     
#     # Enable
#     cf_realip_enabled on;
# }

# ============================================================================
# NOTES
# ============================================================================
#
# 1. The module generates a file like /etc/nginx/cloudflare-ips.conf containing:
#    set_real_ip_from 103.21.244.0/22;
#    set_real_ip_from 103.22.200.0/22;
#    ... (all Cloudflare IP ranges)
#
# 2. The file is updated atomically (temp file + rename) to prevent partial reads.
#
# 3. Updates only happen when content changes (SHA256 hash comparison).
#
# 4. On fetch failures, the module uses exponential backoff (up to 4x interval).
#
# 5. Check nginx error logs for module messages:
#    grep cf_realip /var/log/nginx/error.log
#
# 6. After the module updates the file, you may want to reload nginx:
#    nginx -t && nginx -s reload
#
# 7. For automatic reload on changes, consider using inotifywait:
#    while inotifywait -e modify /etc/nginx/cloudflare-ips.conf; do
#        nginx -t && nginx -s reload
#    done
